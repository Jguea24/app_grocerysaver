(function () {
  function randomDigits(length) {
    var out = '';
    for (var i = 0; i < length; i += 1) {
      out += Math.floor(Math.random() * 10);
    }
    return out;
  }

  function buildEan13() {
    var base = randomDigits(12);
    var sum = 0;
    for (var i = 0; i < base.length; i += 1) {
      var digit = parseInt(base.charAt(i), 10);
      sum += i % 2 === 0 ? digit : digit * 3;
    }
    var checkDigit = (10 - (sum % 10)) % 10;
    return base + String(checkDigit);
  }

  function buildQrValue() {
    if (window.crypto && window.crypto.randomUUID) {
      return 'QR-' + window.crypto.randomUUID();
    }
    return 'QR-' + Date.now() + '-' + randomDigits(6);
  }

  function generateCode(typeValue) {
    if (typeValue === 'qr') {
      return buildQrValue();
    }
    return buildEan13();
  }

  function getRowElement(node) {
    return node.closest('tr') || node.closest('.form-row') || node.parentElement;
  }

  function bindCodeTypeSelect(selectElement) {
    if (!selectElement || selectElement.dataset.autofillBound === '1') {
      return;
    }
    selectElement.dataset.autofillBound = '1';

    var row = getRowElement(selectElement);
    if (!row) {
      return;
    }
    var codeInput = row.querySelector('input[name$="-code"]');
    if (!codeInput) {
      return;
    }

    codeInput.addEventListener('input', function () {
      codeInput.dataset.autoGenerated = '0';
    });

    function maybeGenerate() {
      var current = (codeInput.value || '').trim();
      var wasAutoGenerated = codeInput.dataset.autoGenerated === '1';
      if (current && !wasAutoGenerated) {
        return;
      }
      codeInput.value = generateCode(selectElement.value);
      codeInput.dataset.autoGenerated = '1';
    }

    selectElement.addEventListener('change', maybeGenerate);
    selectElement.addEventListener('click', maybeGenerate);

    if (!(codeInput.value || '').trim()) {
      maybeGenerate();
    }
  }

  function bindAll(root) {
    var container = root || document;
    var selects = container.querySelectorAll('select[name$="-code_type"]');
    for (var i = 0; i < selects.length; i += 1) {
      bindCodeTypeSelect(selects[i]);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    bindAll(document);

    var bodyObserver = new MutationObserver(function (mutations) {
      for (var i = 0; i < mutations.length; i += 1) {
        var mutation = mutations[i];
        for (var j = 0; j < mutation.addedNodes.length; j += 1) {
          var node = mutation.addedNodes[j];
          if (node.nodeType !== 1) {
            continue;
          }
          bindAll(node);
        }
      }
    });

    bodyObserver.observe(document.body, { childList: true, subtree: true });
  });
})();
